%% tpbvp_ode.m
%
% Description:
%   Wrapper function for autogen_tpbvp_ode.m
%   Computes the vector field for the two-point boundary value problem
%   (TPBVP) that results from applying Pontryagin's Maximum Principle (PMP)
%   to the cart-pendulum swingup task with quadratic running cost
%       x'*Q*x + u'*R*u
%
% Inputs:
%   t: (scalar) time (required by MATLAB's numerical integrators/solvers)
%   z: (8x1 column vector) z = [x;lambda] where the robot state is
%       x = [q; dq]
%         = [x_cart; theta_pend; dx_cart; dtheta_pend] and where the
%       costate is
%           lambda = [lambda1; lambda2; lambda3; lambda4].
%   params: a struct with many elements, generated by calling init_params.m
%
% Outputs:
%   dz: the right-hand side of the system of 1st-order ODEs that govern the
%       TPBVP dynamics. dz has same shape as z (8x1)

function dz = tpbvp_ode(t,z,params)

% break up "z" into robot state "x" and costate "lambda":
x = z(1:4);
lambda = z(5:8);

% break up state "x" into generalized coordinates and velocities:
x_cart      = x(1);
theta_pend  = x(2);
dx_cart     = x(3);
dtheta_pend = x(4);

dz = autogen_tpbvp_ode(params.model.dyn.pend.I,...
                       params.control.swingup.Q(1,1),...
                       params.control.swingup.Q(1,2),...
                       params.control.swingup.Q(1,3),...
                       params.control.swingup.Q(1,4),...
                       params.control.swingup.Q(2,1),...
                       params.control.swingup.Q(2,2),...
                       params.control.swingup.Q(2,3),...
                       params.control.swingup.Q(2,4),...
                       params.control.swingup.Q(3,1),...
                       params.control.swingup.Q(3,2),...
                       params.control.swingup.Q(3,3),...
                       params.control.swingup.Q(3,4),...
                       params.control.swingup.Q(4,1),...
                       params.control.swingup.Q(4,2),...
                       params.control.swingup.Q(4,3),...
                       params.control.swingup.Q(4,4),...
                       params.control.swingup.R,...
                       params.model.dyn.b1,...
                       params.model.dyn.b2,...
                       dtheta_pend,...
                       dx_cart,...
                       params.model.dyn.g,...
                       lambda(1),...
                       lambda(2),...
                       lambda(3),...
                       lambda(4),...
                       params.model.dyn.cart.m,...
                       params.model.dyn.pend.m,...
                       params.model.dyn.pend.r_com,...
                       theta_pend,...
                       x_cart);

end